/* eslint-disable react/no-unknown-property */
import React, { useEffect } from 'react'
import { Provider } from 'react-redux'
import { ModalsController } from '@components/ModalsController/ModalsController'
import RedirectionHandler from '@components/RedirectionHandler/RedirectionHandler'
import Layout, { Layouts } from '@layouts/index'
import { dispatch } from '@redux/hooks'
import { usersMiddleware } from '@redux/slices/users'
import store from '@redux/store'
import { Loading } from '@uiComponents/Loading'
import { NextComponentType, NextPageContext } from 'next'
import { Roboto } from 'next/font/google'
import Head from 'next/head'

import '@utils/i18n'

import Middleware from '../Middleware'

import '@styles/globals.css'

const roboto = Roboto({
  weight: ['400', '500'],
  subsets: ['latin'],
  variable: '--font-roboto',
})

interface IAppProps {
  Component: NextComponentType<NextPageContext, never> & {
    Layout: keyof typeof Layouts
  }
  pageProps: JSX.IntrinsicAttributes
}

const App = ({ Component, pageProps }: IAppProps) => {
  const HierarchicalLayout = Layouts[Component.Layout]
  const [initialRenderComplete, setInitialRenderComplete] = React.useState(false)

  useEffect(() => {
    const data = window.localStorage.getItem('language')

    if (data) {
      dispatch(usersMiddleware.changeLanguage(data))
    }
  }, [])

  useEffect(() => {
    setInitialRenderComplete(true)
  }, [])

  if (!initialRenderComplete) {
    return (
      <div className="flex h-[100vh] content-center items-center">
        <Loading />
      </div>
    )
  }

  return (
    <>
      <style
        jsx
        global
      >
        {`
          html {
            font-family: ${roboto.style.fontFamily};
          }
        `}
      </style>
      <Head>
        <title>BEP Armenia</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <link
          rel="icon"
          href="/favicon.ico"
        />
      </Head>
      <main>
        <Provider store={store}>
          <RedirectionHandler />
          <Middleware>
            <Layout>
              {HierarchicalLayout ? (
                <HierarchicalLayout>
                  <Component {...pageProps} />
                </HierarchicalLayout>
              ) : (
                <Component {...pageProps} />
              )}
            </Layout>
          </Middleware>
          <ModalsController />
        </Provider>
      </main>
    </>
  )
}

export default App
